<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>Маршрут — прототип</title>

    <style>
      :root{
        --app-padding: 12px;
      }
      body{background: #f1f1f1;}

      /* Карточка «автобус + время» */
      .route-card .item-title{font-weight:700}
      .bus-chip{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .55rem;border-radius:.5rem;background:#f1f1f1;color:#1b5cff;font-weight:700}
      .bus-chip small{font-weight:600;opacity:.7}
      .eta-dot{width:.55rem;height:.55rem;border-radius:50%;background:#27ae60;display:inline-block;margin-right:.35rem;box-shadow:0 0 0 4px rgba(6, 212, 41, 0.247)}

      /* Блок вагона/дверей */
      .coach{position:relative;display:flex;align-items:center;gap:.35rem;margin:10px 0;padding:10px;border-radius:12px;background:#fff;border:1px solid #e9edf5;}
      .coach .wagon{position:relative;flex:1;height:38px;border-radius:10px;background:linear-gradient(180deg,#fafcff,#eef2f9);border:1px solid #dde3ef;display:flex;justify-content:space-between;align-items:center;padding:0 12px;}
      .coach .wagon::after{content:"";position:absolute;inset:0;border-radius:10px;box-shadow:inset 0 1px 0 rgba(255,255,255,.8);}
      .coach .wagon .door{width:22%;height:70%;border-radius:6px;border:1px dashed #cbd6ea;display:flex;align-items:center;justify-content:center;opacity:.9}
      .coach .wagon .door i{font-style:normal;font-size:.65rem;color:#8a99b5}

      /* Зелёная подсказка двери */
      .entrance-pointer{position:absolute;top:-8px;height:54px;width:54px;border-radius:12px;border:1px solid #e1efea;background:#f4fbf8;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:transform .45s cubic-bezier(.25,.8,.25,1), opacity .25s ease;}
      .entrance-pointer .dot{width:12px;height:12px;border-radius:50%;background:#2ecc71;box-shadow:0 0 0 4px rgba(46,204,113,.15)}

      /* Позиции (1..3) — вычисляются через CSS-переменную */
      .coach{--x:0%}
      .coach .entrance-pointer{left:calc(8% + var(--x));}
      .coach{border: none !important;border-radius: 0; box-shadow: none !important;}

      /* Ряд с мини-схемой автобуса */
      .bus-row{
        display:flex;
        align-items:center;
        justify-content:flex-start;
        gap:12px;
        margin:6px 0 35px 0;
      }

      /* Сам автобус как фон (inline SVG, офлайн) */
      .bus-schematic{
        position:relative;
        width:120px;
        height:28px;
        background-repeat:no-repeat;
        background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 28'><rect x='2' y='5' rx='4' ry='4' width='110' height='18' fill='%23d5d9df'/><rect x='10' y='9' width='12' height='10' fill='%23f1f1f1'/><rect x='42' y='9' width='12' height='10' fill='%23f1f1f1'/><rect x='74' y='9' width='12' height='10' fill='%23f1f1f1'/><circle cx='26' cy='24' r='4' fill='%239aa0a6'/><circle cx='95' cy='24' r='4' fill='%239aa0a6'/></svg>");
      }

      /* Невидимые «слоты» дверей поверх схемы */
      .bus-schematic .door{
        position:absolute;
        top:8px;
        width:12px;
        height:12px;
        border-radius:2px;
        transition: all 0.45s cubic-bezier(.25,.8,.25,1);
      }
      /* Позиции дверей: дверь 1 слева, дверь 3 справа */
      .bus-schematic .door.door-back{ left:10px; }     /* слева - ЗАДНЯЯ */
      .bus-schematic .door.door-middle{ left:42px; }   /* центр - СРЕДНЯЯ */
      .bus-schematic .door.door-front{ left:74px; }    /* справа - ПЕРЕДНЯЯ */

      /* Подсказка «рекомендуемая дверь» */
      .bus-schematic .door.suggested{
        outline:2px solid #10b981;
        outline-offset:2px;
        transform: scale(1.2);
      }

      /* Бейдж маршрута «734» со зелёным буллетом справа */
      .route-mini-chip{
        display:inline-flex; align-items:center; gap:8px;
        height:26px; padding:0 10px;
        background:#f1f1f1; border-radius:8px; font-weight:700;
        color:#0f172a;
      }
      .route-mini-chip .dot{
        width:10px; height:10px; border-radius:50%;
        background:#10b981; box-shadow:0 0 0 4px rgba(16,185,129,.18);
      }

      /* Время справа от ряда */
      .bus-row .eta{
        margin-left:auto;
        font-weight:600;
        color:#16a34a;
        padding-right: 9px;
      }

      /* Гладкая индикация текущего выбора */
      .seg-control .button{min-width:46px}

      /* Вспомогательное форматирование */
      .section-title{font-size:.8rem;color:#000000;margin:6px 0 4px 2px}

      /* Стили для формы загрузки изображений */
      .image-form {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
      }

      .form-group {
        margin-bottom: 12px;
      }

      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        color: #374151;
        font-size: 14px;
      }

      .form-group input, .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
      }

      .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
      }

      .gate-positions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .gate-checkbox {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .gate-checkbox input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      .remove-image-btn {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 4px 8px;
        font-size: 12px;
        cursor: pointer;
        margin-top: 8px;
      }

      .remove-image-btn:hover {
        background: #dc2626;
      }

      /* Стили для упорядоченного списка позиций ворот */
      .gate-order-list {
        margin-top: 8px;
        padding: 8px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        min-height: 40px;
      }

      .gate-order-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        margin: 4px 0;
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        cursor: move;
        transition: all 0.2s ease;
        user-select: none;
      }

      .gate-order-item:hover {
        background: #f1f5f9;
        border-color: #0ea5e9;
      }

      .gate-order-item.dragging {
        opacity: 0.5;
        transform: rotate(5deg);
      }

      .gate-order-item .drag-handle {
        color: #6b7280;
        font-size: 14px;
        cursor: grab;
      }

      .gate-order-item .drag-handle:active {
        cursor: grabbing;
      }

      .gate-order-item .gate-number {
        background: #0ea5e9;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
      }

      .gate-order-item .gate-label {
        flex: 1;
        font-weight: 500;
      }

      .gate-order-item .remove-gate {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 4px;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
      }

      .gate-order-item .remove-gate:hover {
        background: #dc2626;
      }

      .gate-order-placeholder {
        border: 2px dashed #cbd5e1;
        background: #f7fafc;
        border-radius: 6px;
        padding: 8px;
        text-align: center;
        color: #64748b;
        font-size: 14px;
        margin: 4px 0;
      }
    </style>
    <style>
      html,body{margin:0;padding:0}
      body{font:16px/1.35 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,ui-sans-serif,system-ui; color:#1f2937; background:#f1f1f1}
      .navbar{position:sticky; top:0; background:#ffffff; z-index:20; box-shadow:0 4px 12px rgba(0,0,0,0.08); border-bottom:none;}
      .navbar .navbar-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
      .title{font-weight:700}
      .page-content{padding-bottom:24px}
      .block{padding:12px 16px; max-width: 83%}
      .card{background:#f1f1f1;border:none;border-radius:16px;box-shadow:0 6px 16px rgba(24,39,75,.06)}
      .card-content{padding:14px}
      .elevation-3{box-shadow:0 8px 24px rgba(30,41,59,.06)}

      /* Flex utilities */
      .display-flex { display: flex; }
      .justify-content-space-between { justify-content: space-between; }
      .align-items-center { align-items: center; }

      /* Кнопки / сегменты */
      .segmented{display:inline-flex;gap:8px}
      .button{display:inline-flex;align-items:center;justify-content:center;min-width:42px;padding:8px 12px;border-radius:12px;border:1px solid #dbe3f1;background:#fff;text-decoration:none;color:#0f172a;font-weight:600;box-shadow:0 1px 0 rgba(255,255,255,.6), inset 0 -1px 0 rgba(0,0,0,.03)}
      .button-active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}

      /* Ссылки */
      a{color:#2563eb;text-decoration:none}
      a:hover{text-decoration:underline}

      /* Мелкие тексты */
      .text-color-gray{color:#6b7280;padding: 7px 0;}
      .text-color-green{color:#16a34a}

      /* ====== Улучшенный визуал «вагона» ====== */
      .coachwrap{margin-top:8px}
      .coach{--x:36%; position:relative;display:flex;align-items:center;gap:10px;margin:10px 0;padding:12px;border-radius:16px;background:#fff;border:1px solid #e9edf5;box-shadow:0 6px 14px rgba(30,41,59,.05)}
      .coach .wagon{position:relative;flex:1;height:48px;border-radius:12px;background:linear-gradient(180deg,#fdfefe,#eef3fb);border:1px solid #d9e2f1;display:flex;justify-content:space-between;align-items:center;padding:0 14px}
      .coach .wagon::after{content:"";position:absolute;inset:0;border-radius:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,.85)}
      .coach .door{width:22%;height:70%;border-radius:8px;border:1px dashed #c6d3eb;display:flex;align-items:center;justify-content:center;opacity:.95;background:rgba(255,255,255,.6)}
      .coach .door i{font-style:normal;font-size:.75rem;color:#7b8aa6}
      .entrance-pointer{position:absolute;top:-10px;left:calc(8% + var(--x));height:58px;width:58px;border-radius:14px;border:1px solid #d4efe4;background:#f0fbf6;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(16,185,129,.18);transition:transform .45s cubic-bezier(.25,.8,.25,1),left .45s cubic-bezier(.25,.8,.25,1), opacity .25s ease}
      .entrance-pointer .dot{width:12px;height:12px;border-radius:50%;background:#10b981;box-shadow:0 0 0 6px rgba(16,185,129,.18)}

      /* Карточка шапки */
      .bus-chip{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .6rem;border-radius:.6rem;background:#1375fa;color:#fff;font-weight:800}
      .eta-dot{width:.55rem;height:.55rem;border-radius:50%;background:#16a34a;display:inline-block;margin-right:.35rem}

      .section-title {font-family: 'Roboto', sans-serif; font-size: 18px; font-weight: 400; color: #000000; margin: 25px 0 20px 2px;}
      .block-title{padding:4px 16px;margin-top:10px;font-weight:700}
      .list.inset{margin:10px 16px;background:#fff;border:1px solid #e6ebf5;border-radius:16px}
      .list.inset ul{list-style:none;margin:0;padding:0}
      .list.inset li{padding:12px 16px}

      /* ====== Центрированный компактный вид ====== */
      body{padding:24px}
      #app{max-width:420px;max-height: 530px;margin:0 auto;border:1px solid #e5e7eb;border-radius:24px;overflow:hidden;background:#fff;box-shadow:0 18px 48px rgba(15,23,42,.12)}
      .view-main{height:auto;}
      @media (max-width:460px){body{padding:8px};#app{max-width:100%;border-radius:16px}}

      /* ====== Navbar ====== */
      .navbar{position:sticky;top:0;background:#ffffff;border-bottom:1px solid #e5e7eb;z-index:20}
      .navbar-inner{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
      .navbar-inner.two-line{padding:10px 12px 8px;position:relative;min-height:52px;}
      .title-area{position:absolute;left:0;right:0;top:50%;transform:translateY(-50%);text-align:center;line-height:1.1;pointer-events:none;}
      .title-main{font-weight:700;font-size:1rem;color:#0f172a;}
      .title-sub{margin-top:4px;font-size:.85rem;color:#6b7280;}
      .back-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;width:45px !important;height:45px !important;border-radius:12px;background-color:#f1f1f1 !important;border:none;color:#111827;text-decoration:none;pointer-events:none;}
      .back-btn::before{content:"";display:block;width:9px;height:9px;border-left:2px solid #6b7280;border-bottom:2px solid #6b7280;transform:rotate(45deg);}
      .back-btn:hover{background:#f7f7fa}

      /* ====== Средняя зона под топбаром ====== */
      .page-content{position:relative;background:#f1f1f1;padding:12px;min-height:100vh;}
      .page-content::before{content:"";position:absolute;left:12px;right:12px;top:0;background:#ffffff;border-radius:0 0 20px 20px;box-shadow:0 8px 24px rgba(15,23,42,.06);z-index:0;bottom:12px;}
      .page-content > *{position:relative;z-index:2}
      .page-content .block{padding-left:42px;padding-right:12px}

      /* Синий таймлайн слева */
      .timeline{position:absolute;z-index:1;left:35px;top:0;height:408px;width:8px}
      .timeline:after{content:"";position:absolute;left:2px;top:0;height:408px;width:5px;background:#0d64f2;border-radius:2px}
      .timeline .dot{position:absolute;left:50%;transform:translateX(-50%);width:10px;height:10px;border-radius:50%;background:#0d64f2;box-shadow:0 0 0 4px rgb(255, 255, 255);z-index: 2;}
      .navbar {border-bottom: none !important;}

      /* Блок "1 остановка · 4 мин" */
      .stop-summary{
        position: relative;
        padding-top: 22px;
        padding-bottom: 22px;
        margin: 0;
      }

      .stop-summary::before,
      .stop-summary::after{
        content: "";
        position: absolute;
        left: 16px;
        right: 16px;
        height: 1px;
        background: #e9edf5;
      }
      .stop-summary::before{ top: 0; }
      .stop-summary::after{ bottom: 0; }

      .stop-summary .ss-row{
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 16px;
      }

      .stop-summary .acc-arrow{
        display: inline-block;
        width: 10px;
        height: 10px;
        border-right: 2px solid #98a2b3;
        border-bottom: 2px solid #98a2b3;
        transform: rotate(45deg);
        margin-right: 6px;
        opacity: .9;
        position: relative;
        top: -3px;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div class="view view-main">
        <div class="page">
          <div class="navbar navbar-fixed">
            <div class="navbar-inner two-line">
              <div class="left">
                <a href="#" class="back-btn" aria-disabled="true" title="Назад" tabindex="-1"></a>
              </div>
              <div class="title-area">
                <div class="title-main">1 ч 10 мин</div>
                <div class="title-sub">2 пересадки · 15:26</div>
              </div>
              <div class="right"></div>
            </div>
          </div>

          <div class="page-content">
            <div class="timeline">
              <span class="dot" style="top:313px"></span>
              <span class="dot" style="bottom:0px"></span>
            </div>
            <div class="block" style="padding:var(--app-padding); padding-left:50px">
              <!-- Карточка шага с автобусом -->
              <div class="card route-card elevation-3">
                <div class="card-content card-content-padding">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <div class="bus-chip">507</div>
                      <div class="item-title">Автобус</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                      <span class="eta-dot"></span>
                      <span class="text-color-green">6 мин</span>
                    </div>
                  </div>
                  <div class="text-color-gray">
                    В сторону «Метро Саларьево»<br>
                    Следующий через <span class="text-color-green">26 мин</span>
                  </div>
                </div>
              </div>

              <!-- Текст который будет меняться -->
              <div class="section-title" id="boardingText">Садитесь ближе к концу автобуса</div>

              <!-- Мини-схема автобуса -->
              <div class="bus-row">
                <div class="bus-schematic" aria-label="Схема автобуса">
                  <span class="door door-back" id="door-back"></span>
                  <span class="door door-middle" id="door-middle"></span>
                  <span class="door door-front" id="door-front"></span>
                </div>

                <div class="route-mini-chip">
                  <span class="num">734</span>
                  <span class="eta-dot" aria-hidden="true"></span>
                </div>

                <div class="eta">24 мин</div>
              </div>

              <!-- Блок "1 остановка" остается НЕИЗМЕННЫМ -->
              <div class="stop-summary">
                <div class="ss-row">
                  <span class="acc-arrow" aria-hidden="true"></span>
                  <a href="#" class="ss-link">1 остановка</a>
                  <span class="ss-sep">·</span>
                  <span class="text-color-gray">4 мин</span>
                </div>
              </div>

              <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                <div>Метро Саларьево</div>
                <div class="text-color-gray" style="padding-right: 9px;">14:25</div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

<!-- ======= Блок загрузки и отправки фотографий ======= -->
		<div id="uploader-section" style="margin-top: 25px; padding: 18px; background: #f9fafb; border-radius: 14px; border: 1px solid #e5e7eb;">
			<h3 style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">Анализ загруженности</h3>
			<input type="file" id="imageInput" multiple accept="image/*" style="margin-bottom: 10px;">
			<div id="preview" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;"></div>
			<button id="sendBtn" disabled style="padding: 8px 14px; border: none; border-radius: 10px; background-color: #0ea5e9; color: white; font-weight: 600; cursor: pointer;">
				Отправить фотографии
			</button>
		</div>

		<script>
			const input = document.getElementById('imageInput');
			const preview = document.getElementById('preview');
			const sendBtn = document.getElementById('sendBtn');
			let imageData = [];

			// Функция для создания формы для каждого изображения
			function createImageForm(file, index) {
				const formDiv = document.createElement('div');
				formDiv.className = 'image-form';
				formDiv.innerHTML = `
					<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
						<img src="${URL.createObjectURL(file)}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
						<div style="flex: 1;">
							<div style="font-weight: 600; margin-bottom: 4px;">Изображение ${index + 1}</div>
							<div style="font-size: 12px; color: #6b7280;">${file.name}</div>
						</div>
						<button type="button" class="remove-image-btn" onclick="removeImage(${index})">Удалить</button>
					</div>
					
					<div class="form-group">
						<label for="cam_info_${index}">Тип камеры:</label>
						<select id="cam_info_${index}" onchange="updateImageData(${index})">
							<option value="frontal">Фронтальная</option>
							<option value="side">Боковая</option>
							<option value="rear">Задняя</option>
						</select>
					</div>
					
					<div class="form-group">
						<label for="cam_num_${index}">Номер камеры:</label>
						<input type="number" id="cam_num_${index}" value="1" min="1" max="10" onchange="updateImageData(${index})">
					</div>
					
					<div class="form-group">
						<label>Позиции входов (можно выбрать несколько):</label>
						<div class="gate-positions">
							<div class="gate-checkbox">
								<input type="checkbox" id="gate_1_${index}" value="1" onchange="updateImageData(${index})">
								<label for="gate_1_${index}">1</label>
							</div>
							<div class="gate-checkbox">
								<input type="checkbox" id="gate_2_${index}" value="2" onchange="updateImageData(${index})" checked>
								<label for="gate_2_${index}">2</label>
							</div>
							<div class="gate-checkbox">
								<input type="checkbox" id="gate_3_${index}" value="3" onchange="updateImageData(${index})">
								<label for="gate_3_${index}">3</label>
							</div>
							<div class="gate-checkbox">
								<input type="checkbox" id="gate_4_${index}" value="4" onchange="updateImageData(${index})">
								<label for="gate_4_${index}">4</label>
							</div>
						</div>
					</div>

					<div class="form-group">
						<label>Порядок позиций входов (перетащите для изменения порядка):</label>
						<div class="gate-order-list" id="gate-order-${index}">
							<div class="gate-order-placeholder">Выберите позиции входов выше</div>
						</div>
					</div>
				`;
				return formDiv;
			}

			// Функция для обновления данных изображения
			function updateImageData(index) {
				const camInfo = document.getElementById(`cam_info_${index}`).value;
				const camNum = parseInt(document.getElementById(`cam_num_${index}`).value);
				
				// Получаем выбранные позиции ворот
				const gateCheckboxes = document.querySelectorAll(`input[id^="gate_"][id$="_${index}"]:checked`);
				const gatePos = Array.from(gateCheckboxes).map(cb => parseInt(cb.value));
				
				// Обновляем данные изображения
				imageData[index] = {
					...imageData[index],
					cam_info: camInfo,
					cam_num: camNum,
					gate_pos: gatePos
				};

				// Обновляем упорядоченный список
				updateGateOrderList(index);
			}

			// Функция для обновления упорядоченного списка позиций ворот
			function updateGateOrderList(index) {
				const orderList = document.getElementById(`gate-order-${index}`);
				const gatePos = imageData[index]?.gate_pos || [];
				
				if (gatePos.length === 0) {
					orderList.innerHTML = '<div class="gate-order-placeholder">Выберите позиции входов выше</div>';
					return;
				}

				// Создаем элементы для каждой выбранной позиции
				orderList.innerHTML = '';
				gatePos.forEach((gateNum, orderIndex) => {
					const orderItem = document.createElement('div');
					orderItem.className = 'gate-order-item';
					orderItem.draggable = true;
					orderItem.dataset.gateNum = gateNum;
					orderItem.dataset.orderIndex = orderIndex;
					
					orderItem.innerHTML = `
						<span class="drag-handle">⋮⋮</span>
						<div class="gate-number">${orderIndex + 1}</div>
						<div class="gate-label">Позиция ${gateNum}</div>
						<button class="remove-gate" onclick="removeGateFromOrder(${index}, ${gateNum})">×</button>
					`;
					
					// Добавляем обработчики drag and drop
					orderItem.addEventListener('dragstart', handleDragStart);
					orderItem.addEventListener('dragover', handleDragOver);
					orderItem.addEventListener('drop', handleDrop);
					orderItem.addEventListener('dragend', handleDragEnd);
					
					orderList.appendChild(orderItem);
				});
			}

			// Обработчики drag and drop
			let draggedElement = null;

			function handleDragStart(e) {
				draggedElement = e.target;
				e.target.classList.add('dragging');
				e.dataTransfer.effectAllowed = 'move';
			}

			function handleDragOver(e) {
				e.preventDefault();
				e.dataTransfer.dropEffect = 'move';
			}

			function handleDrop(e) {
				e.preventDefault();
				
				if (draggedElement && draggedElement !== e.target) {
					const targetElement = e.target.closest('.gate-order-item');
					if (targetElement) {
						const imageIndex = parseInt(targetElement.closest('[id^="gate-order-"]').id.split('-')[2]);
						const draggedGateNum = parseInt(draggedElement.dataset.gateNum);
						const targetGateNum = parseInt(targetElement.dataset.gateNum);
						
						// Меняем местами элементы в массиве
						const gatePos = imageData[imageIndex].gate_pos;
						const draggedIndex = gatePos.indexOf(draggedGateNum);
						const targetIndex = gatePos.indexOf(targetGateNum);
						
						if (draggedIndex !== -1 && targetIndex !== -1) {
							[gatePos[draggedIndex], gatePos[targetIndex]] = [gatePos[targetIndex], gatePos[draggedIndex]];
							updateGateOrderList(imageIndex);
						}
					}
				}
			}

			function handleDragEnd(e) {
				e.target.classList.remove('dragging');
				draggedElement = null;
			}

			// Функция для удаления позиции из упорядоченного списка
			function removeGateFromOrder(imageIndex, gateNum) {
				const gatePos = imageData[imageIndex].gate_pos;
				const index = gatePos.indexOf(gateNum);
				if (index !== -1) {
					gatePos.splice(index, 1);
					// Снимаем чекбокс
					const checkbox = document.getElementById(`gate_${gateNum}_${imageIndex}`);
					if (checkbox) {
						checkbox.checked = false;
					}
					updateImageData(imageIndex);
				}
			}

			// Функция для удаления изображения
			function removeImage(index) {
				imageData.splice(index, 1);
				renderPreview();
			}

			// Функция для отрисовки превью
			function renderPreview() {
				preview.innerHTML = '';
				imageData.forEach((data, index) => {
					const formDiv = createImageForm(data.file, index);
					preview.appendChild(formDiv);
				});
				
				sendBtn.disabled = imageData.length === 0;
			}

			input.addEventListener('change', async (event) => {
				imageData = [];
				
				for (const file of event.target.files) {
					const reader = new FileReader();
					reader.onload = (e) => {
						const base64 = e.target.result.split(',')[1];
						
						imageData.push({
							file: file,
							image_bytes: base64,
							cam_info: 'frontal',
							cam_num: 1,
							gate_pos: [2] // По умолчанию выбрана позиция 2
						});
						
						// Если это последний файл, отрисовываем превью
						if (imageData.length === event.target.files.length) {
							renderPreview();
						}
					};
					reader.readAsDataURL(file);
				}
			});

			sendBtn.addEventListener('click', async () => {
				if (imageData.length === 0) return;

				sendBtn.disabled = true;
				sendBtn.textContent = 'Отправка...';

				try {
					// Подготавливаем данные для отправки
					const imagesToSend = imageData.map(data => ({
						image_bytes: data.image_bytes,
						cam_info: data.cam_info,
						cam_num: data.cam_num,
						gate_pos: data.gate_pos
					}));

					const response = await fetch('http://localhost:1338/api/v1/crowd_analysis', {
						method: 'POST',
						headers: {'Content-Type': 'application/json'},
						body: JSON.stringify({ images: imagesToSend })
					});

					const result = await response.json();
					console.log('Ответ сервера:', result);

					// Отображаем количество людей
					if ('people' in result) {
						displayPeopleCount(result.people);
					}

					if ('free_entrance' in result) {
						const url = new URL(window.location);
						url.searchParams.set('entrance_suggestion', result.free_entrance);
						window.location.href = url.toString();
					}

				} catch (error) {
					alert('Ошибка при отправке запроса');
					console.error(error);
				} finally {
					sendBtn.disabled = false;
					sendBtn.textContent = 'Отправить фотографии';
				}
			});

			// Функция для отображения количества людей
			function displayPeopleCount(peopleCount) {
				// Создаем или обновляем блок с количеством людей
				let peopleBlock = document.getElementById('people-count-block');
				
				if (!peopleBlock) {
					peopleBlock = document.createElement('div');
					peopleBlock.id = 'people-count-block';
					peopleBlock.style.cssText = `
						margin-top: 15px;
						padding: 16px;
						background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
						border-radius: 12px;
						color: white;
						text-align: center;
						box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
						animation: slideIn 0.5s ease-out;
					`;
					
					// Добавляем CSS анимацию
					const style = document.createElement('style');
					style.textContent = `
						@keyframes slideIn {
							from {
								opacity: 0;
								transform: translateY(20px);
							}
							to {
								opacity: 1;
								transform: translateY(0);
							}
						}
					`;
					document.head.appendChild(style);
					
					// Вставляем блок после секции загрузки
					document.getElementById('uploader-section').insertAdjacentElement('afterend', peopleBlock);
				}

				// Определяем уровень загруженности и соответствующий текст
				let level, levelText, icon;
				if (peopleCount === 0) {
					level = 'empty';
					levelText = 'Пусто';
					icon = '🟢';
				} else if (peopleCount <= 10) {
					level = 'low';
					levelText = 'Мало людей';
					icon = '🟡';
				} else if (peopleCount <= 25) {
					level = 'medium';
					levelText = 'Умеренно';
					icon = '🟠';
				} else {
					level = 'high';
					levelText = 'Много людей';
					icon = '🔴';
				}

				// Обновляем содержимое блока
				peopleBlock.innerHTML = `
					<div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px;">
						<span style="font-size: 20px;">${icon}</span>
						<span style="font-size: 18px; font-weight: 600;">${levelText}</span>
					</div>
					<div style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">
						${peopleCount} ${peopleCount === 1 ? 'человек' : peopleCount < 5 ? 'человека' : 'человек'}
					</div>
					<div style="font-size: 14px; opacity: 0.9;">
						Обнаружено на изображениях
					</div>
				`;

				// Добавляем эффект пульсации для привлечения внимания
				peopleBlock.style.animation = 'slideIn 0.5s ease-out, pulse 2s ease-in-out 0.5s';
				
				// Добавляем CSS для пульсации
				if (!document.getElementById('pulse-animation')) {
					const pulseStyle = document.createElement('style');
					pulseStyle.id = 'pulse-animation';
					pulseStyle.textContent = `
						@keyframes pulse {
							0%, 100% { transform: scale(1); }
							50% { transform: scale(1.02); }
						}
					`;
					document.head.appendChild(pulseStyle);
				}
			}
		</script>
<!-- ======= Конец блока загрузки ======= -->

    <script>
      // Функция для получения параметров из URL
      function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Функция для обновления текста в зависимости от двери
      function updateBoardingText(doorNumber) {
        const boardingText = document.getElementById('boardingText');

        if (doorNumber === 0) {
          // Режим "нет рекомендации"
          boardingText.textContent = 'Ещё маршруты';
        } else {
          // Обычный режим с рекомендацией
          const texts = {
            1: 'Садитесь в начало автобуса',
            2: 'Садитесь в центр автобуса',
            3: 'Садитесь ближе к концу автобуса'
          };
          boardingText.textContent = texts[doorNumber] || texts[3];
        }
      }

      // Функция для установки рекомендуемой двери
      function setSuggestedDoor(doorNumber) {
        // Убираем класс suggested со всех дверей
        document.querySelectorAll('.bus-schematic .door').forEach(door => {
          door.classList.remove('suggested');
        });

        if (doorNumber === 0) {
          // Режим "нет рекомендации" - не подсвечиваем двери
          console.log('Режим без рекомендации - зелёная рамка скрыта');
        } else {
          // Обычный режим - подсвечиваем выбранную дверь
          const doorMap = {
            1: 'door-front',
            2: 'door-middle',
            3: 'door-back'
          };

          const selectedDoorId = doorMap[doorNumber];
          const selectedDoor = document.getElementById(selectedDoorId);

          if (selectedDoor) {
            selectedDoor.classList.add('suggested');
          }
        }

        // Обновляем позицию зеленого указателя (если он есть)
        updateEntrancePointer(doorNumber);

        // Обновляем текст
        updateBoardingText(doorNumber);
      }

      // Функция для обновления позиции зеленого указателя
      function updateEntrancePointer(doorNumber) {
        const coach = document.querySelector('.coach');
        if (coach) {
          if (doorNumber === 0) {
            // В режиме без рекомендации скрываем указатель
            coach.style.setProperty('--x', '-100%');
          } else {
            const positions = {
              1: '68%',
              2: '36%',
              3: '4%'
            };
            coach.style.setProperty('--x', positions[doorNumber] || positions[2]);
          }
        }
      }

      // Основная функция инициализации
      function init() {
        // Получаем параметр из URL
        const suggestedDoor = getUrlParameter('entrance_suggestion');

        if (suggestedDoor && ['0', '1', '2', '3'].includes(suggestedDoor)) {
          // Устанавливаем дверь из параметра URL
          setSuggestedDoor(parseInt(suggestedDoor));
          console.log(`Установлен режим: ${suggestedDoor === '0' ? 'без рекомендации' : 'дверь ' + suggestedDoor}`);
        } else {
          // Устанавливаем дверь по умолчанию (задняя дверь)
          setSuggestedDoor(3);
          console.log('Установлена дверь по умолчанию: 3 (задняя дверь)');
        }

        // Добавляем обработчик для изменения URL
        window.addEventListener('popstate', function() {
          const newSuggestedDoor = getUrlParameter('entrance_suggestion');
          if (newSuggestedDoor && ['0', '1', '2', '3'].includes(newSuggestedDoor)) {
            setSuggestedDoor(parseInt(newSuggestedDoor));
          }
        });
      }

      // Запускаем инициализацию когда DOM загружен
      document.addEventListener('DOMContentLoaded', init);

      // Функция для тестирования
      function testDoorChange(doorNumber) {
        const newUrl = `${window.location.pathname}?entrance_suggestion=${doorNumber}`;
        window.history.pushState({}, '', newUrl);
        setSuggestedDoor(doorNumber);
      }

      // Экспортируем для тестирования в консоли
      window.testDoorChange = testDoorChange;

      console.log('Приложение загружено. Для тестирования используйте:');
      console.log('testDoorChange(0) - режим без рекомендации ("Ещё маршруты")');
      console.log('testDoorChange(1) - для передней двери (справа)');
      console.log('testDoorChange(2) - для средней двери (центр)');
      console.log('testDoorChange(3) - для задней двери (слева)');
    </script>
  </body>
</html>